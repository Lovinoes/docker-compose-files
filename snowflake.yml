# /opt/snowflake
# https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake

name: Snowflake
services:
  snowflake1:
    image: containers.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake:latest
    container_name: snowflake1
    restart: unless-stopped
    command: ["-ephemeral-ports-range", "10000:20000"]
    networks:
      snowflake-macvlan:
        ipv4_address: 172.23.178.101
        ipv6_address: fd23:178::101
    labels:
      autoheal: "true"

  snowflake2:
    image: containers.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake:latest
    container_name: snowflake2
    restart: unless-stopped
    command: ["-ephemeral-ports-range", "20001:30000"]
    networks:
      snowflake-macvlan:
        ipv4_address: 172.23.178.102
        ipv6_address: fd23:178::102
    labels:
      autoheal: "true"

  snowflake3:
    image: containers.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake:latest
    container_name: snowflake3
    restart: unless-stopped
    command: ["-ephemeral-ports-range", "30001:40000"]
    networks:
      snowflake-macvlan:
        ipv4_address: 172.23.178.103
        ipv6_address: fd23:178::103
    labels:
      autoheal: "true"

  snowflake4:
    image: containers.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake:latest
    container_name: snowflake4
    restart: unless-stopped
    command: ["-ephemeral-ports-range", "40001:50000"]
    networks:
      snowflake-macvlan:
        ipv4_address: 172.23.178.104
        ipv6_address: fd23:178::104
    labels:
      autoheal: "true"

  snowflake5:
    image: containers.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake:latest
    container_name: snowflake5
    restart: unless-stopped
    command: ["-ephemeral-ports-range", "50001:60000"]
    networks:
      snowflake-macvlan:
        ipv4_address: 172.23.178.105
        ipv6_address: fd23:178::105
    labels:
      autoheal: "true"

  snowflake_heal:
    image: willfarrell/autoheal:latest
    container_name: snowflake_heal
    restart: unless-stopped
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

networks:
  snowflake-macvlan:
    driver: macvlan
    driver_opts:
      parent: eth0   # replace with your host interface
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 172.23.178.0/24
          gateway: 172.23.178.1
        - subnet: fd23:178::/64
          gateway: fd23:178::1
